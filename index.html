<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mercado de Natal de Santar â€” Mapa Interativo</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; }
    .pill { display:inline-block; background:#0f172a; color:#e2e8f0; padding:2px 8px; border-radius:999px; font-size:12px; }
    .qr-btn, .route-btn {
      position: absolute; top: 16px; background: #0f172a; color: #e2e8f0;
      border: 1px solid rgba(255,255,255,.15); border-radius: 999px;
      padding: 8px 14px; cursor: pointer; font-size: 13px; z-index: 5000;
    }
    .route-btn { right: 150px; }
    .qr-btn { right: 16px; }
    .qr-btn:hover, .route-btn:hover { background:#111827; }
    /* small panel for buttons */
    .poi-panel {
      position: absolute;
      left: 16px;
      top: 70px;
      background: rgba(15,23,42,.85);
      padding: 8px;
      border-radius: 12px;
      z-index: 4000;
      max-width: 190px;
    }
    .poi-panel h4 {
      margin: 0 0 6px 0;
      color: #e2e8f0;
      font-size: 13px;
    }
    .poi-panel button {
      width: 100%;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.04);
      color: #e2e8f0;
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 8px;
      text-align: left;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .poi-panel button:hover {
      background: rgba(255,255,255,.09);
    }
    /* QR modal */
    .qr-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .qr-box {
      background: #0f172a;
      border: 1px solid rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 14px 16px 18px;
      color: #e2e8f0;
      width: min(320px, 90vw);
      text-align: center;
    }
    .qr-close {
      background: transparent;
      border: none;
      color: #e2e8f0;
      float: right;
      font-size: 18px;
      cursor: pointer;
    }
    .qr-url {
      font-size: 11px;
      color: #94a3b8;
      word-break: break-all;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- buttons -->
  <button class="route-btn" id="goToStart">ðŸ§­ Ir para o inÃ­cio do mercado</button>
  <button class="qr-btn" id="openQr">ðŸ“± QR do mapa</button>

  <!-- small POI panel -->
  <div class="poi-panel">
    <h4>Locais do percurso</h4>
    <button data-poi="rua-estremadouro">1. Rua do Estremadouro</button>
    <button data-poi="largo-paco">2. Largo do PaÃ§o</button>
    <button data-poi="rua-carreira">3. Rua da Carreira</button>
    <button data-poi="rua-sacadura">4. Rua Sacadura Cabral</button>
    <button data-poi="rua-direita">5. Rua Direita</button>
    <button data-poi="travessa-miragaia">6. Travessa da Miragaia</button>
    <button data-poi="rua-miragaia">7. Rua da Miragaia</button>
    <button data-poi="av-taveiro">8. Av. Viscondessa de Taveiro</button>
  </div>

  <!-- QR modal -->
  <div class="qr-overlay" id="qrOverlay">
    <div class="qr-box">
      <button class="qr-close" id="closeQr">Ã—</button>
      <h3>QR do Mapa</h3>
      <p>Scan para abrir:</p>
      <div id="qrcode" style="width:200px;height:200px;margin:0 auto;"></div>
      <div class="qr-url">https://nevessusie.github.io/mercadodesantar/</div>
    </div>
  </div>

  <script>
    const START_COORDS = [40.5709815, -7.8907183];

    // 1. Map
    const map = L.map('map').setView(START_COORDS, 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    L.control.locate({ strings: { title: 'A minha localizaÃ§Ã£o' } }).addTo(map);

    // 2. Route points
    const ROUTE_POINTS = [
      {
        key: 'rua-estremadouro',
        name: 'Rua do Estremadouro',
        desc: 'Rua das Grinaldas Â· Entrada / SaÃ­da do Mercado',
        coords: START_COORDS
      },
      {
        key: 'largo-paco',
        name: 'Largo do PaÃ§o',
        desc: 'Mercado do Natal Â· Estrelas e Ãrvores',
        coords: [40.572213, -7.891578]
      },
      {
        key: 'rua-carreira',
        name: 'Rua da Carreira',
        desc: 'Luzes LÃ¡grimas',
        query: 'Rua da Carreira, Santar, Portugal'
      },
      {
        key: 'rua-sacadura',
        name: 'Rua Sacadura Cabral',
        desc: 'Luzes de Natal',
        query: 'Rua Sacadura Cabral, Santar, Portugal'
      },
      {
        key: 'rua-direita',
        name: 'Rua Direita',
        desc: 'Rua das Bengalas',
        query: 'Rua Direita, Santar, Portugal'
      },
      {
        key: 'travessa-miragaia',
        name: 'Travessa da Miragaia',
        desc: 'Travessa Dourada',
        query: 'Travessa da Miragaia, Santar, Portugal'
      },
      {
        key: 'rua-miragaia',
        name: 'Rua da Miragaia',
        desc: 'Rua das Estrelas',
        query: 'Rua da Miragaia, Santar, Portugal'
      },
      {
        key: 'av-taveiro',
        name: 'Av. Viscondessa de Taveiro',
        desc: 'Estrelas',
        coords: [40.5708916, -7.8908457] // last of the 3 points
      }
    ];

    async function geocode(q) {
      const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q));
      const data = await res.json();
      if (!data.length) throw new Error('NÃ£o encontrado: ' + q);
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }

    async function resolvePoint(p) {
      if (p.coords) return p.coords;
      return await geocode(p.query);
    }

    const markerMap = {}; // key -> marker

    async function buildRoute() {
      const coords = [];
      for (const p of ROUTE_POINTS) {
        const c = await resolvePoint(p);
        coords.push(c);
        const m = L.circleMarker(c, {
          radius: 7,
          weight: 2,
          color: '#0f172a',
          fillColor: p.key === 'rua-estremadouro' ? '#22c55e' : '#ffffff',
          fillOpacity: 0.95
        }).addTo(map)
          .bindPopup(`<strong>${p.name}</strong><br>${p.desc || ''}`);
        markerMap[p.key] = m;
      }
      // close the loop back to start
      coords.push(START_COORDS);
      L.polyline(coords, { color:'#e11d48', weight:6, opacity:0.95 }).addTo(map);
      map.fitBounds(L.polyline(coords).getBounds().pad(0.2));
    }
    buildRoute().catch(e => alert('Erro ao construir percurso: ' + e.message));

    // 3. QR overlay
    const qrUrl = "https://nevessusie.github.io/mercadodesantar/";
    const openBtn = document.getElementById('openQr');
    const overlay = document.getElementById('qrOverlay');
    const closeBtn = document.getElementById('closeQr');

    openBtn.addEventListener('click', () => {
      overlay.style.display = 'flex';
      const box = document.getElementById('qrcode');
      box.innerHTML = '';
      new QRCode(box, {
        text: qrUrl,
        width: 200,
        height: 200,
        correctLevel: QRCode.CorrectLevel.M
      });
    });
    closeBtn.addEventListener('click', () => overlay.style.display = 'none');
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.style.display = 'none'; });

    // 4. Routing from user to start
    let userRoute = null;
    document.getElementById('goToStart').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('O seu dispositivo nÃ£o permite localizaÃ§Ã£o.');
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const userLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
        if (userRoute) {
          map.removeControl(userRoute);
          userRoute = null;
        }
        userRoute = L.Routing.control({
          waypoints: [
            userLatLng,
            L.latLng(START_COORDS[0], START_COORDS[1])
          ],
          router: L.Routing.osrmv1({
            serviceUrl: 'https://routing.openstreetmap.de/routed-foot/route/v1'
          }),
          lineOptions: { styles: [{ color: '#22c55e', weight: 5, opacity: 0.9 }] },
          addWaypoints: false,
          draggableWaypoints: false,
          fitSelectedRoutes: true,
          show: false
        }).addTo(map);
      }, () => alert('NÃ£o foi possÃ­vel obter a localizaÃ§Ã£o.'));
    });

    // 5. make buttons open popups
    document.querySelectorAll('.poi-panel button').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.getAttribute('data-poi');
        const marker = markerMap[key];
        if (marker) {
          map.setView(marker.getLatLng(), 18);
          marker.openPopup();
        }
      });
    });
  </script>
</body>
</html>

     
