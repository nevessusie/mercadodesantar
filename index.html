<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mercado de Natal de Santar â€” Mapa Interativo</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
  <!-- QRCode library -->
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; }
    .pill { display:inline-block; background:#0f172a; color:#e2e8f0; padding:2px 8px; border-radius:999px; font-size:12px; }
    .legend {
      position:absolute; bottom:16px; right:16px;
      background:rgba(15,23,42,.9); color:#e2e8f0;
      padding:10px 12px; border-radius:14px; max-width:260px; z-index:3000;
    }
    .legend h3 { margin:0 0 6px 0; font-size:13px; }
    /* buttons top-right */
    .qr-btn, .route-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #0f172a;
      color: #e2e8f0;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 999px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 13px;
      z-index: 5000;
    }
    .route-btn {
      right: 150px;
    }
    .qr-btn:hover, .route-btn:hover { background:#111827; }
    /* QR modal */
    .qr-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .qr-box {
      background: #0f172a;
      border: 1px solid rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 14px 16px 18px;
      color: #e2e8f0;
      width: min(320px, 90vw);
      text-align: center;
    }
    .qr-close {
      background: transparent;
      border: none;
      color: #e2e8f0;
      float: right;
      font-size: 18px;
      cursor: pointer;
    }
    .qr-url {
      font-size: 11px;
      color: #94a3b8;
      word-break: break-all;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- buttons -->
  <button class="route-btn" id="goToStart">ðŸ§­ Ir para o inÃ­cio do mercado</button>
  <button class="qr-btn" id="openQr">ðŸ“± QR do mapa</button>

  <!-- legend -->


  <!-- QR modal -->
  <div class="qr-overlay" id="qrOverlay">
    <div class="qr-box">
      <button class="qr-close" id="closeQr">Ã—</button>
      <h3>QR do Mapa</h3>
      <p>Scan para abrir:</p>
      <div id="qrcode" style="width:200px;height:200px;margin:0 auto;"></div>
      <div class="qr-url">https://nevessusie.github.io/mercadodesantar/</div>
    </div>
  </div>

  <script>
    // 1. Base map
    const START_COORDS = [40.5709815, -7.8907183]; // entrada/saÃ­da
    const map = L.map('map').setView(START_COORDS, 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    L.control.locate({ strings: { title: 'A minha localizaÃ§Ã£o' } }).addTo(map);

    // 2. Route points (loop)
    const ROUTE_POINTS = [
      {
        name: 'Rua do Estremadouro',
        desc: 'Rua das Grinaldas Â· Entrada / SaÃ­da do Mercado',
        coords: START_COORDS
      },
      {
        name: 'Largo do PaÃ§o',
        desc: 'Mercado do Natal Â· Estrelas e Ãrvores',
        coords: [40.572213, -7.891578]
      },
      {
        name: 'Rua da Carreira',
        desc: 'Luzes LÃ¡grimas',
        query: 'Rua da Carreira, Santar, Portugal'
      },
      {
        name: 'Rua Sacadura Cabral',
        desc: 'Luzes de Natal',
        query: 'Rua Sacadura Cabral, Santar, Portugal'
      },
      {
        name: 'Rua Direita',
        desc: 'Rua das Bengalas',
        query: 'Rua Direita, Santar, Portugal'
      },
      {
        name: 'Travessa da Miragaia',
        desc: 'Travessa Dourada',
        query: 'Travessa da Miragaia, Santar, Portugal'
      },
      {
        name: 'Rua da Miragaia',
        desc: 'Rua das Estrelas',
        query: 'Rua da Miragaia, Santar, Portugal'
      },
      {
        name: 'Av. Viscondessa de Taveiro (1)',
        desc: 'Estrelas',
        coords: [40.5703380, -7.8920255]
      },
      {
        name: 'Av. Viscondessa de Taveiro (2)',
        desc: 'Estrelas',
        coords: [40.5705491, -7.8916316]
      },
      {
        name: 'Av. Viscondessa de Taveiro (3)',
        desc: 'Estrelas',
        coords: [40.5708916, -7.8908457]
      },
      {
        name: 'Rua do Estremadouro (Fim)',
        desc: 'Regresso ao ponto inicial',
        coords: START_COORDS
      }
    ];

    async function geocode(q) {
      const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q));
      const data = await res.json();
      if (!data.length) throw new Error('NÃ£o encontrado: ' + q);
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }

    async function resolvePoint(p) {
      if (p.coords) return p.coords;
      return await geocode(p.query);
    }

    async function buildRoute() {
      const coords = [];
      for (const p of ROUTE_POINTS) {
        coords.push(await resolvePoint(p));
      }
      coords.forEach((c, i) => {
        const p = ROUTE_POINTS[i];
        L.circleMarker(c, {
          radius: 7,
          weight: 2,
          color: '#0f172a',
          fillColor: i === 0 ? '#22c55e' : '#ffffff',
          fillOpacity: 0.95
        }).addTo(map)
          .bindPopup(`<strong>${i+1}. ${p.name}</strong><br>${p.desc || ''}`);
      });
      const line = L.polyline(coords, { color:'#e11d48', weight:6, opacity:0.95 }).addTo(map);
      map.fitBounds(line.getBounds().pad(0.2));
    }

    buildRoute().catch(e => alert('Erro ao construir percurso: ' + e.message));

    // 3. QR overlay
    const qrUrl = "https://nevessusie.github.io/mercadodesantar/";
    const openBtn = document.getElementById('openQr');
    const overlay = document.getElementById('qrOverlay');
    const closeBtn = document.getElementById('closeQr');

    openBtn.addEventListener('click', () => {
      overlay.style.display = 'flex';
      const box = document.getElementById('qrcode');
      box.innerHTML = '';
      new QRCode(box, {
        text: qrUrl,
        width: 200,
        height: 200,
        correctLevel: QRCode.CorrectLevel.M
      });
    });
    closeBtn.addEventListener('click', () => overlay.style.display = 'none');
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.style.display = 'none'; });

    // 4. "Ir para o inÃ­cio do mercado" = routing from user to START
    let userRoute = null;
    document.getElementById('goToStart').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('O seu dispositivo nÃ£o permite localizaÃ§Ã£o.');
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const userLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
        // remove previous route
        if (userRoute) {
          map.removeControl(userRoute);
          userRoute = null;
        }
        userRoute = L.Routing.control({
          waypoints: [
            userLatLng,
            L.latLng(START_COORDS[0], START_COORDS[1])
          ],
          router: L.Routing.osrmv1({
            serviceUrl: 'https://routing.openstreetmap.de/routed-foot/route/v1'
          }),
          lineOptions: {
            styles: [{ color: '#22c55e', weight: 5, opacity: 0.9 }]
          },
          addWaypoints: false,
          draggableWaypoints: false,
          fitSelectedRoutes: true,
          show: false
        }).addTo(map);
      }, () => {
        alert('NÃ£o foi possÃ­vel obter a localizaÃ§Ã£o.');
      });
    });
  </script>
</body>
</html>

