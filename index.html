<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mercado de Natal de Santar ‚Äî Mapa Interativo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.js"></script>
  <!-- QRCode library -->
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; }
    .pill { display:inline-block; background:#0f172a; color:#e2e8f0; padding:2px 8px; border-radius:999px; font-size:12px; }
    .legend { position:absolute; bottom:16px; right:16px; background:rgba(15,23,42,.9); color:#e2e8f0; padding:10px 12px; border-radius:14px; max-width:260px; }
    .legend h3 { margin:0 0 6px 0; font-size:13px; }
    /* QR button */
    .qr-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #0f172a;
      color: #e2e8f0;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 999px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 13px;
      z-index: 5000;
    }
    .qr-btn:hover { background:#111827; }
    /* Modal */
    .qr-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .qr-box {
      background: #0f172a;
      border: 1px solid rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 14px 16px 18px;
      color: #e2e8f0;
      width: min(320px, 90vw);
      text-align: center;
    }
    .qr-close {
      background: transparent;
      border: none;
      color: #e2e8f0;
      float: right;
      font-size: 18px;
      cursor: pointer;
    }
    .qr-url {
      font-size: 11px;
      color: #94a3b8;
      word-break: break-all;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- floating button -->
  <button class="qr-btn" id="openQr">üì± QR do mapa</button>

  <!-- legend -->
  <div class="legend">
    <h3>Percurso do Mercado</h3>
    1. Rua do Estremadouro ‚Äî <em>Rua das Grinaldas (Entrada / Sa√≠da)</em><br>
    2. Largo do Pa√ßo ‚Äî <em>Mercado do Natal: Estrelas e √Årvores</em><br>
    3. Rua da Carreira ‚Äî <em>Luzes L√°grimas</em><br>
    4. Rua Sacadura Cabral ‚Äî <em>Luzes de Natal</em><br>
    5. Rua Direita ‚Äî <em>Rua das Bengalas</em><br>
    6. Travessa da Miragaia ‚Äî <em>Travessa Dourada</em><br>
    7. Rua da Miragaia ‚Äî <em>Rua das Estrelas</em><br>
    8‚Äì10. Av. Viscondessa de Taveiro ‚Äî <em>Estrelas</em><br>
    11. Volta ao ponto inicial
  </div>

  <!-- QR modal -->
  <div class="qr-overlay" id="qrOverlay">
    <div class="qr-box">
      <button class="qr-close" id="closeQr">√ó</button>
      <h3>QR do Mapa</h3>
      <p>Scan para abrir:</p>
      <div id="qrcode" style="width:200px;height:200px;margin:0 auto;"></div>
      <div class="qr-url">https://nevessusie.github.io/mercadodesantar/</div>
    </div>
  </div>

  <script>
    // Mapa base
    const map = L.map('map').setView([40.5709815, -7.8907183], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    L.control.locate({ strings: { title: 'A minha localiza√ß√£o' } }).addTo(map);

    // pontos do percurso (start == finish)
    const ROUTE_POINTS = [
      {
        name: 'Rua do Estremadouro',
        desc: 'Rua das Grinaldas ¬∑ Entrada / Sa√≠da do Mercado',
        coords: [40.5709815, -7.8907183]
      },
      {
        name: 'Largo do Pa√ßo',
        desc: 'Mercado do Natal ¬∑ Estrelas e √Årvores',
        coords: [40.572213, -7.891578]
      },
      {
        name: 'Rua da Carreira',
        desc: 'Luzes L√°grimas',
        query: 'Rua da Carreira, Santar, Portugal'
      },
      {
        name: 'Rua Sacadura Cabral',
        desc: 'Luzes de Natal',
        query: 'Rua Sacadura Cabral, Santar, Portugal'
      },
      {
        name: 'Rua Direita',
        desc: 'Rua das Bengalas',
        query: 'Rua Direita, Santar, Portugal'
      },
      {
        name: 'Travessa da Miragaia',
        desc: 'Travessa Dourada',
        query: 'Travessa da Miragaia, Santar, Portugal'
      },
      {
        name: 'Rua da Miragaia',
        desc: 'Rua das Estrelas',
        query: 'Rua da Miragaia, Santar, Portugal'
      },
      // 3 pontos da avenida
      {
        name: 'Av. Viscondessa de Taveiro (1)',
        desc: 'Estrelas',
        coords: [40.5703380, -7.8920255]
      },
      {
        name: 'Av. Viscondessa de Taveiro (2)',
        desc: 'Estrelas',
        coords: [40.5705491, -7.8916316]
      },
      {
        name: 'Av. Viscondessa de Taveiro (3)',
        desc: 'Estrelas',
        coords: [40.5708916, -7.8908457]
      },
      // fechar o c√≠rculo
      {
        name: 'Rua do Estremadouro (Fim)',
        desc: 'Regresso ao ponto inicial',
        coords: [40.5709815, -7.8907183]
      }
    ];

    async function geocode(q) {
      const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q));
      const data = await res.json();
      if (!data.length) throw new Error('N√£o encontrado: ' + q);
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }

    async function resolvePoint(p) {
      if (p.coords) return p.coords;
      return await geocode(p.query);
    }

    async function buildRoute() {
      const coords = [];
      for (const p of ROUTE_POINTS) {
        coords.push(await resolvePoint(p));
      }
      coords.forEach((c, i) => {
        const p = ROUTE_POINTS[i];
        L.circleMarker(c, {
          radius: 7,
          weight: 2,
          color: '#0f172a',
          fillColor: i === 0 ? '#22c55e' : '#ffffff',
          fillOpacity: 0.95
        }).addTo(map)
          .bindPopup(`<strong>${i+1}. ${p.name}</strong><br>${p.desc || ''}`);
      });
      const line = L.polyline(coords, { color:'#e11d48', weight:6, opacity:0.95 }).addTo(map);
      map.fitBounds(line.getBounds().pad(0.2));
    }

    buildRoute().catch(e => alert('Erro ao construir percurso: ' + e.message));

    // QR overlay logic
    const qrUrl = "https://nevessusie.github.io/mercadodesantar/";
    const openBtn = document.getElementById('openQr');
    const overlay = document.getElementById('qrOverlay');
    const closeBtn = document.getElementById('closeQr');

    openBtn.addEventListener('click', () => {
      overlay.style.display = 'flex';
      const box = document.getElementById('qrcode');
      box.innerHTML = '';
      new QRCode(box, {
        text: qrUrl,
        width: 200,
        height: 200,
        correctLevel: QRCode.CorrectLevel.M
      });
    });

    closeBtn.addEventListener('click', () => {
      overlay.style.display = 'none';
    });

    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) overlay.style.display = 'none';
    });
  </script>
</body>
</html>

