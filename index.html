<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mercado de Natal de Santar ‚Äî Mapa Interativo</title>
  <!-- Favicon: make sure favicon.png exists in the repo root -->
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Leaflet & plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; }
    .pill {
      display:inline-block;
      background:#0f172a;
      color:#e2e8f0;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
    }

    /* top-right buttons */
    .qr-btn, .route-btn, .clear-btn {
      position: absolute;
      top: 16px;
      background: #0f172a;
      color: #e2e8f0;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 999px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 13px;
      z-index: 5000;
      white-space: nowrap;
    }
    .route-btn { right: 230px; }
    .clear-btn { right: 150px; }
    .qr-btn { right: 16px; }
    .qr-btn:hover, .route-btn:hover, .clear-btn:hover { background:#111827; }

    /* POI panel (left side) */
    .poi-panel {
      position: absolute;
      left: 16px;
      top: 70px;
      background: rgba(15,23,42,.85);
      padding: 8px;
      border-radius: 12px;
      z-index: 4000;
      max-width: 190px;
    }
    .poi-panel h4 {
      margin: 0 0 6px 0;
      color: #e2e8f0;
      font-size: 13px;
    }
    .poi-panel button {
      width: 100%;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.04);
      color: #e2e8f0;
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 8px;
      text-align: left;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .poi-panel button:hover {
      background: rgba(255,255,255,.09);
    }

    /* QR modal */
    .qr-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .qr-box {
      background: #0f172a;
      border: 1px solid rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 14px 16px 18px;
      color: #e2e8f0;
      width: min(320px, 90vw);
      text-align: center;
    }
    .qr-close {
      background: transparent;
      border: none;
      color: #e2e8f0;
      float: right;
      font-size: 18px;
      cursor: pointer;
    }
    .qr-url {
      font-size: 11px;
      color: #94a3b8;
      word-break: break-all;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- top buttons -->
  <button class="route-btn" id="goToStart">üß≠ Ir para o in√≠cio do mercado</button>
  <button class="clear-btn" id="clearRoute">üßπ Limpar rota</button>
  <button class="qr-btn" id="openQr">üì± QR do mapa</button>

  <!-- left POI panel -->
  <div class="poi-panel">
    <h4>Locais do percurso</h4>
    <button data-poi="rua-estremadouro">1. Rua do Estremadouro</button>
    <button data-poi="largo-paco">2. Largo do Pa√ßo</button>
    <button data-poi="rua-carreira">3. Rua da Carreira</button>
    <button data-poi="rua-sacadura">4. Rua Sacadura Cabral</button>
    <button data-poi="rua-direita">5. Rua Direita</button>
    <button data-poi="travessa-miragaia">6. Travessa da Miragaia</button>
    <button data-poi="rua-miragaia">7. Rua da Miragaia</button>
    <button data-poi="av-taveiro">8. Av. Viscondessa de Taveiro</button>
  </div>

  <!-- QR modal -->
  <div class="qr-overlay" id="qrOverlay">
    <div class="qr-box">
      <button class="qr-close" id="closeQr">√ó</button>
      <h3>QR do Mapa</h3>
      <p>Scan para abrir:</p>
      <div id="qrcode" style="width:200px;height:200px;margin:0 auto;"></div>
      <div class="qr-url">https://nevessusie.github.io/mercadodesantar/</div>
    </div>
  </div>

  <script>
    const START_COORDS = [40.5709815, -7.8907183];
    const MAP_URL = "https://nevessusie.github.io/mercadodesantar/";

    // 1. Map
    const map = L.map('map').setView(START_COORDS, 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    L.control.locate({ strings: { title: 'A minha localiza√ß√£o' } }).addTo(map);

    // 2. Data structure for route points
    const ROUTE_POINTS = [
      {
        key: 'rua-estremadouro',
        name: 'Rua do Estremadouro',
        desc: 'Rua das Grinaldas ¬∑ Entrada / Sa√≠da do Mercado',
        coords: START_COORDS
      },
      {
        key: 'largo-paco',
        name: 'Largo do Pa√ßo',
        desc: 'Mercado do Natal ¬∑ Estrelas e √Årvores',
        coords: [40.572213, -7.891578]
      },
      {
        key: 'rua-carreira',
        name: 'Rua da Carreira',
        desc: 'Luzes L√°grimas',
        query: 'Rua da Carreira, Santar, Portugal'
      },
      {
        key: 'rua-sacadura',
        name: 'Rua Sacadura Cabral',
        desc: 'Luzes de Natal',
        query: 'Rua Sacadura Cabral, Santar, Portugal'
      },
      {
        key: 'rua-direita',
        name: 'Rua Direita',
        desc: 'Rua das Bengalas',
        query: 'Rua Direita, Santar, Portugal'
      },
      {
        key: 'travessa-miragaia',
        name: 'Travessa da Miragaia',
        desc: 'Travessa Dourada',
        query: 'Travessa da Miragaia, Santar, Portugal'
      },
      {
        key: 'rua-miragaia',
        name: 'Rua da Miragaia',
        desc: 'Rua das Estrelas',
        query: 'Rua da Miragaia, Santar, Portugal'
      },
      {
        key: 'av-taveiro',
        name: 'Av. Viscondessa de Taveiro',
        desc: 'Estrelas',
        coords: [40.5708916, -7.8908457] // final avenida point
      }
    ];

    // 3. Geocoding helpers
    async function geocode(q) {
      const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q));
      const data = await res.json();
      if (!data.length) throw new Error('N√£o encontrado: ' + q);
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }
    async function resolvePoint(p) {
      if (p.coords) return p.coords;
      return await geocode(p.query);
    }

    // 4. Routing helpers
    let userRoute = null;
    const markerMap = {};  // key -> marker
    const coordMap  = {};  // key -> [lat, lng]

    function clearUserRoute() {
      if (userRoute) {
        map.removeControl(userRoute);
        userRoute = null;
      }
    }

    function routeFromMyLocationTo(destLatLng) {
      if (!navigator.geolocation) {
        alert('O seu dispositivo n√£o permite localiza√ß√£o.');
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const userLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
        clearUserRoute();
        userRoute = L.Routing.control({
          waypoints: [
            userLatLng,
            L.latLng(destLatLng.lat, destLatLng.lng)
          ],
          router: L.Routing.osrmv1({
            serviceUrl: 'https://routing.openstreetmap.de/routed-foot/route/v1'
          }),
          lineOptions: { styles: [{ color: '#22c55e', weight: 5, opacity: 0.95 }] },
          addWaypoints: false,
          draggableWaypoints: false,
          fitSelectedRoutes: true,
          show: false
        }).addTo(map);
      }, () => {
        alert('N√£o foi poss√≠vel obter a localiza√ß√£o.');
      });
    }

    function routeToKey(key) {
      const c = coordMap[key];
      if (!c) {
        alert('Destino inv√°lido.');
        return;
      }
      routeFromMyLocationTo(L.latLng(c[0], c[1]));
    }

    // 5. Build route, markers & polyline
    async function buildRoute() {
      const coords = [];

      for (const p of ROUTE_POINTS) {
        const c = await resolvePoint(p);
        coords.push(c);
        coordMap[p.key] = c;

        const popupHtml = `
          <strong>${p.name}</strong><br>
          ${p.desc || ''}
          <div style="margin-top:6px">
            <button data-route-key="${p.key}" class="route-here"
              style="background:#0f172a;color:#e2e8f0;border:1px solid rgba(255,255,255,.15);
                     border-radius:8px;padding:4px 8px;cursor:pointer;font-size:12px">
              üß≠ Tra√ßar caminho at√© aqui
            </button>
          </div>
        `;

        const m = L.circleMarker(c, {
          radius: 7,
          weight: 2,
          color: '#0f172a',
          fillColor: p.key === 'rua-estremadouro' ? '#22c55e' : '#ffffff',
          fillOpacity: 0.95
        }).addTo(map).bindPopup(popupHtml);

        markerMap[p.key] = m;
      }

      // Close loop back to start (for the red route)
      coords.push(START_COORDS);
      const routeLine = L.polyline(coords, { color:'#e11d48', weight:6, opacity:0.95 }).addTo(map);
      map.fitBounds(routeLine.getBounds().pad(0.2));
    }

    buildRoute().catch(e => alert('Erro ao construir percurso: ' + e.message));

    // 6. Wire popups: ‚ÄúTra√ßar caminho at√© aqui‚Äù
    map.on('popupopen', (e) => {
      const btn = e.popup.getElement().querySelector('button.route-here');
      if (btn) {
        const key = btn.getAttribute('data-route-key');
        btn.addEventListener('click', () => routeToKey(key));
      }
    });

    // 7. Left panel buttons (open popup & focus)
    document.querySelectorAll('.poi-panel button[data-poi]').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.getAttribute('data-poi');
        const marker = markerMap[key];
        if (marker) {
          map.setView(marker.getLatLng(), 18);
          marker.openPopup();
        }
      });
    });

    // 8. ‚ÄúIr para o in√≠cio do mercado‚Äù button
    document.getElementById('goToStart').addEventListener('click', () => {
      routeFromMyLocationTo(L.latLng(START_COORDS[0], START_COORDS[1]));
    });

    // 9. Clear route button
    document.getElementById('clearRoute').addEventListener('click', clearUserRoute);

    // 10. QR overlay
    const openBtn = document.getElementById('openQr');
    const overlay = document.getElementById('qrOverlay');
    const closeBtn = document.getElementById('closeQr');

    openBtn.addEventListener('click', () => {
      overlay.style.display = 'flex';
      const box = document.getElementById('qrcode');
      box.innerHTML = '';
      new QRCode(box, {
        text: MAP_URL,
        width: 200,
        height: 200,
        correctLevel: QRCode.CorrectLevel.M
      });
    });
    closeBtn.addEventListener('click', () => overlay.style.display = 'none');
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) overlay.style.display = 'none';
    });
  </script>
</body>
</html>
